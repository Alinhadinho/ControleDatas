<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>Scanner de Produtos</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      background-color: #0A2E73;
      color: white;
      height: 100vh;
    }
    header {
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #051A48;
    }
    header h2 {
      font-size: 18px;
      margin: 0;
    }
    button {
      background: #1E5AF0;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 15px;
      cursor: pointer;
    }
    button.secondary { background: #555; }
    #reader {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: black;
      margin: 10px;
      border-radius: 10px;
      overflow: hidden;
    }
    #msg {
      padding: 10px;
      text-align: center;
      color: #ccc;
    }
    footer {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 12px;
    }
  </style>

  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <header>
    <button id="backBtn">⬅ Voltar</button>
    <h2>Scanner</h2>
    <span></span>
  </header>

  <div id="reader"></div>
  <div id="msg">Toque em "Iniciar" e permita o uso da câmera.</div>

  <footer>
    <button id="startBtn">Iniciar</button>
    <button id="stopBtn" class="secondary" disabled>Parar</button>
    <button id="switchBtn" class="secondary">Trocar Câmera</button>
  </footer>

  <script>
    const readerDivId = "reader";
    let scanner = null;
    let cameras = [];
    let currentCam = null;

    // envia resultado para o Flet (Python)
    function sendToFlet(data) {
      window.parent.postMessage(data, "*");
    }

    async function listarCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        cameras = devices || [];
        console.log("Câmeras detectadas:", cameras);
      } catch (err) {
        document.getElementById("msg").innerText = "Erro ao listar câmeras: " + err;
      }
    }

    async function iniciarScanner(cameraId) {
      if (scanner) return;
      const config = { fps: 10, qrbox: { width: 300, height: 200 }, rememberLastUsedCamera: true };
      scanner = new Html5Qrcode(readerDivId);
      try {
        await scanner.start(
          cameraId ? { deviceId: { exact: cameraId } } : { facingMode: "environment" },
          config,
          (decodedText, decodedResult) => {
            document.getElementById("msg").innerText = "Código: " + decodedText;
            sendToFlet(decodedText);  // envia para o app Flet
          }
        );
        document.getElementById("msg").innerText = "Scanner ativo — aponte para o código.";
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
      } catch (e) {
        document.getElementById("msg").innerText = "Erro ao iniciar: " + e.message;
      }
    }

    async function pararScanner() {
      if (!scanner) return;
      await scanner.stop();
      await scanner.clear();
      scanner = null;
      document.getElementById("msg").innerText = "Scanner parado.";
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    }

    async function trocarCamera() {
      if (cameras.length <= 1) {
        alert("Nenhuma outra câmera detectada.");
        return;
      }
      const idx = cameras.findIndex(c => c.id === currentCam);
      const next = (idx + 1) % cameras.length;
      currentCam = cameras[next].id;
      await pararScanner();
      await iniciarScanner(currentCam);
    }

    // eventos de botão
    document.getElementById("startBtn").addEventListener("click", async () => {
      if (cameras.length === 0) await listarCameras();
      currentCam = (cameras[0] && cameras[0].id) || null;
      iniciarScanner(currentCam);
    });
    document.getElementById("stopBtn").addEventListener("click", pararScanner);
    document.getElementById("switchBtn").addEventListener("click", trocarCamera);
    document.getElementById("backBtn").addEventListener("click", () => sendToFlet("CANCEL_SCAN"));

    // lista câmeras no carregamento
    listarCameras();
  </script>
</body>
</html>
